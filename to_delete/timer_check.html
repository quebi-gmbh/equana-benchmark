<!DOCTYPE html>
<html>
<head>
    <title>Timer Sanity Check</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        pre { background: #0d0d1a; padding: 15px; }
    </style>
</head>
<body>
    <h1>Timer Sanity Check</h1>
    <button onclick="runCheck()">Run Check</button>
    <pre id="output">Click to run...</pre>
    
    <script>
    function runCheck() {
        const out = document.getElementById('output');
        let log = '';
        
        // 1. Check timer resolution
        log += '=== Timer Resolution ===\n';
        const samples = [];
        let last = performance.now();
        for (let i = 0; i < 100; i++) {
            let now;
            while ((now = performance.now()) === last) {}
            samples.push(now - last);
            last = now;
        }
        const minRes = Math.min(...samples);
        const avgRes = samples.reduce((a,b) => a+b) / samples.length;
        log += `Min resolution: ${minRes.toFixed(4)} ms\n`;
        log += `Avg resolution: ${avgRes.toFixed(4)} ms\n`;
        
        // 2. Busy-wait timing test
        log += '\n=== Busy-Wait Calibration ===\n';
        
        // Calibrate: find how many iterations = ~100ms
        let iters = 1000000;
        let elapsed = 0;
        while (elapsed < 50) {
            iters *= 2;
            const start = performance.now();
            let x = 0;
            for (let i = 0; i < iters; i++) {
                x += Math.sin(i * 0.001);
            }
            elapsed = performance.now() - start;
            // Prevent optimization
            if (x === Infinity) console.log(x);
        }
        
        log += `Calibrated: ${iters} iterations = ${elapsed.toFixed(2)} ms\n`;
        log += `Rate: ${(iters / elapsed / 1000).toFixed(2)} M iter/ms\n`;
        
        // 3. Consistency test - run 5 times
        log += '\n=== Consistency Test (5 runs) ===\n';
        const times = [];
        for (let r = 0; r < 5; r++) {
            const start = performance.now();
            let x = 0;
            for (let i = 0; i < iters; i++) {
                x += Math.sin(i * 0.001);
            }
            const t = performance.now() - start;
            times.push(t);
            if (x === Infinity) console.log(x);
        }
        log += `Times: ${times.map(t => t.toFixed(2) + 'ms').join(', ')}\n`;
        const avg = times.reduce((a,b) => a+b) / times.length;
        const stddev = Math.sqrt(times.reduce((s, t) => s + (t - avg) ** 2, 0) / times.length);
        log += `Avg: ${avg.toFixed(2)} ms, StdDev: ${stddev.toFixed(2)} ms (${(stddev/avg*100).toFixed(1)}%)\n`;
        
        // 4. Quick WASM test if available
        log += '\n=== Conclusion ===\n';
        if (minRes < 0.01) {
            log += '✓ High-precision timer (< 10µs resolution)\n';
        } else if (minRes < 0.1) {
            log += '⚠ Medium-precision timer (10-100µs resolution)\n';
        } else {
            log += '✗ Low-precision timer (> 100µs resolution) - may affect benchmarks\n';
        }
        
        if (stddev / avg < 0.05) {
            log += '✓ Consistent timing (< 5% variance)\n';
        } else {
            log += '⚠ Inconsistent timing (> 5% variance)\n';
        }
        
        out.textContent = log;
    }
    </script>
</body>
</html>
